package cs22510_2014;

import java.io.FileNotFoundException;
import java.io.PrintWriter;
import java.util.LinkedList;

public class Controller {
	private GPSReader strm_1, strm_2; // stream 1 and stream 2
	private LinkedList<GPSReader.Location> locs;
	private long lat_offset;
	private long lng_offset;
	private final static double MIL = 1000000.0;

	private Controller(String file1, String file2) {
		strm_1 = new GPSReader(file1);
		strm_2 = new GPSReader(file2);
		locs = new LinkedList<>();
	}

	private boolean syncTimesGPS() {
		int lineRead = 0;
		while (lineRead != GPSReader.GPS_TIME && lineRead != GPSReader._EOF) {
			lineRead = strm_1.read();

		}
		if (lineRead == GPSReader._EOF) {
			return false;
		}

		lineRead = 0;
		while (lineRead != GPSReader.GPS_TIME && lineRead != GPSReader._EOF) {
			lineRead = strm_2.read();
		}
		if (lineRead == GPSReader._EOF) {
			return false;
		}

		int timeDiff = strm_1.currTime.compareTo(strm_2.currTime);

		if (timeDiff == -1) {
			do {
				lineRead = strm_1.read();
				if (lineRead == GPSReader._EOF)
					return false;
				if (lineRead == GPSReader.GPS_TIME) {
					timeDiff = strm_1.currTime.compareTo(strm_2.currTime);
				}

			} while (timeDiff != 0);

		} else if (timeDiff == 1) {
			do {
				lineRead = strm_2.read();
				if (lineRead == GPSReader._EOF)
					return false;
				if (lineRead == GPSReader.GPS_TIME) {
					timeDiff = strm_1.currTime.compareTo(strm_2.currTime);

				}
			} while (timeDiff != 0);

		}

		return true;
	}

	private void getoffset(GPSReader.Location one, GPSReader.Location two) {

		this.lat_offset = (long) (one.lat * MIL) - (long) (two.lat * MIL);

		this.lng_offset = (long) (one.lng * MIL) - (long) (two.lng * MIL);

	}

	private void addoffset(GPSReader.Location goodFix, GPSReader.Location badFix) {

		badFix.lat = Math.round(goodFix.lat * MIL + this.lat_offset) / MIL;

		badFix.lng = Math.round(goodFix.lng * MIL + this.lng_offset) / MIL;

	}

	private void start() {
		this.syncSatelite();
		this.syncTimesGPS();
		while (true) {

			if (strm_1.satelitesOK) {

				locs.add(strm_1.currLoc);
				if (strm_2.satelitesOK)
					this.getoffset(strm_1.currLoc, strm_2.currLoc);

				else
					this.addoffset(strm_1.currLoc, strm_2.currLoc);

			} else if (strm_2.satelitesOK) {
				locs.add(strm_2.currLoc);
				this.addoffset(strm_2.currLoc, strm_1.currLoc);

			}
			int lineRead = 0;
			do {
				lineRead = strm_1.read();
				if (lineRead == GPSReader._EOF)
					return;

			} while (lineRead != GPSReader.GPS_TIME);
			lineRead = 0;
			do {
				lineRead = strm_2.read();
				if (lineRead == GPSReader._EOF)
					return;

			} while (lineRead != GPSReader.GPS_TIME);

		}

	}

	private boolean syncSatelite() {
		int lineRead = 0;
		if (!strm_1.satelitesOK) {
			while (!strm_1.satelitesOK) {
				lineRead = strm_1.read();
				if (lineRead == GPSReader._EOF)
					return false;
			}
		}
		if (!strm_2.satelitesOK) {
			while (!strm_2.satelitesOK) {
				lineRead = strm_2.read();

				if (lineRead == GPSReader._EOF)
					return false;
			}
		}

		return true;
	}

	public static void go() {

		String file1 = "/home/evdjoint/gps_1.dat";
		String file2 = "/home/evdjoint/gps_2.dat";

		Controller controller = new Controller(file1, file2);

		controller.start();

		PrintWriter pw = null;
		try {

			pw = new PrintWriter("data.gpx");
			pw.write("<?xml version=\"1.0\"?>\n"
					+ "<gpx "
					+ "version=\"1.0\"\n"
					+ "creator=\"Evdzhan Mustafa\"\n"
					+ "xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n");

			for (GPSReader.Location l : controller.locs) {
				pw.write("<wpt lat=\"" + l.lat + "\" lon=\"" + l.lng + "\">\n"
						+ "<time>" + l.date.toString() + "\n</time>"
						+ "\n</wpt>\n");
			}

			pw.write("</gpx>");

		} catch (FileNotFoundException e) {

			e.printStackTrace();
		}
		pw.close();

	}

}
