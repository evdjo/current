package cs22510_2014;

import java.io.FileNotFoundException;
import java.io.PrintWriter;
import java.util.LinkedList;

public class Controller {
	protected GPSReader strm1, strm2; // stream 1 and stream 2
	protected LinkedList<GPSReader.Location> locs; // the place to store the
													// locations
	protected long latOffset;
	protected long lngOffset;
	private final static double MIL = 1000000.0;

	protected Controller(String file1, String file2) {
		strm1 = new GPSReader(file1);
		strm2 = new GPSReader(file2);
		locs = new LinkedList<>();
	}

	public boolean synchronizeTimes() {
		int lineRead = 0;
		while (lineRead != GPSReader.GPS_TIME && lineRead != GPSReader._EOF) {
			lineRead = strm1.read();

		}
		if (lineRead == GPSReader._EOF) {
			return false;
		}

		lineRead = 0;
		while (lineRead != GPSReader.GPS_TIME && lineRead != GPSReader._EOF) {
			lineRead = strm2.read();
		}
		if (lineRead == GPSReader._EOF) {
			return false;
		}

		int timeDiff = strm1.currTime.compareTo(strm2.currTime);

		if (timeDiff == -1) {
			do {
				lineRead = strm1.read();
				if (lineRead == GPSReader._EOF)
					return false;
				if (lineRead == GPSReader.GPS_TIME) {
					timeDiff = strm1.currTime.compareTo(strm2.currTime);
				}

			} while (timeDiff != 0);

		} else if (timeDiff == 1) {
			do {
				lineRead = strm2.read();
				if (lineRead == GPSReader._EOF)
					return false;
				if (lineRead == GPSReader.GPS_TIME) {
					timeDiff = strm1.currTime.compareTo(strm2.currTime);

				}
			} while (timeDiff != 0);

		}

		return true;
	}

	private void getoffset(GPSReader.Location one, GPSReader.Location two) {

		this.latOffset = (long) (one.lat * MIL) - (long) (two.lat * MIL);

		this.lngOffset = (long) (one.lng * MIL) - (long) (two.lng * MIL);

	}

	private void addoffset(GPSReader.Location goodFix, GPSReader.Location badFix) {

		badFix.lat = Math.round(goodFix.lat * MIL + this.latOffset) / MIL;

		badFix.lng = Math.round(goodFix.lng * MIL + this.lngOffset) / MIL;

	}

	protected void start() {
		this.synchronizeGPS();
		this.synchronizeTimes();
		while (true) {

			if (strm1.satelitesOK) {

				locs.add(strm1.currLoc);
				if (strm2.satelitesOK)
					this.getoffset(strm1.currLoc, strm2.currLoc);

				else
					this.addoffset(strm1.currLoc, strm2.currLoc);

			} else if (strm2.satelitesOK) {
				locs.add(strm2.currLoc);
				this.addoffset(strm2.currLoc, strm1.currLoc);

			}
			int lineRead = 0;
			do {
				lineRead = strm1.read();
				if (lineRead == GPSReader._EOF)
					return;

			} while (lineRead != GPSReader.GPS_TIME);
			lineRead = 0;
			do {
				lineRead = strm2.read();
				if (lineRead == GPSReader._EOF)
					return;

			} while (lineRead != GPSReader.GPS_TIME);

		}

	}

	private boolean synchronizeGPS() {
		int  lineRead = 0;
		if (!strm1.satelitesOK) {
			while (!strm1.satelitesOK) {
				lineRead = strm1.read();
				if (lineRead == GPSReader._EOF)
					return false;
			}
		}
		if (!strm2.satelitesOK) {
			while (!strm2.satelitesOK) {
				lineRead = strm2.read();

				if (lineRead == GPSReader._EOF)
					return false;
			}
		}

		return true;
	}

	static void go() {

		String file1 = "/home/evdjoint/gps_1.dat";
		String file2 = "/home/evdjoint/gps_2.dat";

		Controller controller = new Controller(file1, file2);

		controller.synchronizeTimes();

		controller.start();

		PrintWriter pw = null;
		try {

			pw = new PrintWriter("data.gpx");
			pw.write("<?xml version=\"1.0\"?>\n"
					+ "<gpx "
					+ "version=\"1.0\"\n"
					+ "creator=\"Evdzhan Mustafa\"\n"
					+ "xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n");

			for (GPSReader.Location l : controller.locs) {
				pw.write("<wpt lat=\"" + l.lat + "\" lon=\"" + l.lng + "\">\n"
						+ "<time>" + l.date.toString() + "\n</time>"
						+ "\n</wpt>\n");
			}

			pw.write("</gpx>");

		} catch (FileNotFoundException e) {

			e.printStackTrace();
		}
		pw.close();

	}

}
